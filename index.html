import React, { useState, useRef, useEffect } from 'react';
import { Printer, Upload, RotateCcw, User, Award, QrCode, Download, Image as ImageIcon, FileText, Link as LinkIcon, FileJson } from 'lucide-react';

export default function App() {
  const [data, setData] = useState({
    candidateName: "Alex Morgan",
    description: "For outstanding dedication and remarkable contribution to the community project. Your hard work and commitment have been an inspiration to us all.",
    founderName: "Sarah Connor",
    signatoryTitle: "Founder / Head",
    founderEmail: "sarah@institution.org",
    date: new Date().toISOString().split('T')[0],
    institutionName: "Royal Academy of Arts",
    title: "Certificate of Appreciation",
    verificationUrl: ""
  });

  const [qrMode, setQrMode] = useState('details'); // 'details' (text) or 'link' (url)
  const [image, setImage] = useState(null);
  const [areScriptsLoaded, setAreScriptsLoaded] = useState(false);
  const [isGenerating, setIsGenerating] = useState(false);
  
  const fileInputRef = useRef(null);
  const certificateRef = useRef(null);

  // Load html2canvas and jspdf
  useEffect(() => {
    const loadScript = (src) => {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.async = true;
        script.onload = resolve;
        script.onerror = reject;
        document.body.appendChild(script);
      });
    };

    Promise.all([
      loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'),
      loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js')
    ]).then(() => {
      setAreScriptsLoaded(true);
    }).catch(err => {
      console.error("Failed to load generation scripts", err);
    });
  }, []);

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setData(prev => ({ ...prev, [name]: value }));
  };

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const imageUrl = URL.createObjectURL(file);
      setImage(imageUrl);
    }
  };

  const handlePrint = () => {
    window.print();
  };

  const handleDownloadPDF = async () => {
    if (!areScriptsLoaded) {
      alert("PDF generator is still loading. Please wait a moment.");
      return;
    }
    setIsGenerating(true);

    try {
      const element = certificateRef.current;
      
      const canvas = await window.html2canvas(element, {
        scale: 2, 
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#fffcf5', 
        logging: false
      });

      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('l', 'mm', 'a4');
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();

      pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
      pdf.save(`${data.candidateName.replace(/\s+/g, '_')}_Certificate.pdf`);

    } catch (error) {
      console.error("PDF generation error:", error);
      alert("Failed to generate PDF. Please try the 'Download Image' option instead.");
    } finally {
      setIsGenerating(false);
    }
  };

  const handleDownloadImage = async () => {
    if (!areScriptsLoaded) return;
    setIsGenerating(true);
    
    try {
      const element = certificateRef.current;
      const canvas = await window.html2canvas(element, {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#fffcf5'
      });

      const link = document.createElement('a');
      link.download = `${data.candidateName.replace(/\s+/g, '_')}_Certificate.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    } catch (error) {
      console.error("Image generation error:", error);
    } finally {
      setIsGenerating(false);
    }
  };

  const handleReset = () => {
    if (window.confirm("Are you sure you want to clear all fields?")) {
        setData({
            candidateName: "",
            description: "",
            founderName: "",
            signatoryTitle: "",
            founderEmail: "",
            date: new Date().toISOString().split('T')[0],
            institutionName: "",
            title: "Certificate of Appreciation",
            verificationUrl: ""
        });
        setImage(null);
    }
  };

  // Logic to generate QR content
  const getQrData = () => {
    if (qrMode === 'link') {
        return data.verificationUrl || "https://example.com";
    } else {
        // Clearer plain text format for Google Lens
        return `CERTIFICATE OF AUTHENTICITY\n\nRecipient: ${data.candidateName}\nIssued By: ${data.institutionName}\nDate: ${data.date}\nSigned: ${data.founderName}\n\nStatus: VERIFIED`;
    }
  };

  // Increased size to 400x400 for better scan resolution
  // Added ecc=M for medium error correction (makes it more robust)
  const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&ecc=M&margin=10&data=${encodeURIComponent(getQrData())}`;

  return (
    <div className="min-h-screen bg-gray-100 font-sans text-gray-800">
      {/* Google Fonts Injection */}
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;800&family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&display=swap');
        
        /* Font Definitions */
        .font-header { font-family: 'Cinzel', serif; }
        .font-body { font-family: 'Cormorant Garamond', serif; }
        
        /* Custom Colors */
        .text-gold { color: #b49b57; }
        .border-gold { border-color: #b49b57; }
        .bg-gold { background-color: #b49b57; }
        .bg-parchment { background-color: #fffcf5; }

        @media print {
          .no-print { display: none !important; }
          body { margin: 0; padding: 0; background: white; }
          .print-area { 
            display: flex !important; 
            width: 100% !important; 
            height: 100vh !important;
            position: fixed;
            top: 0; left: 0;
            margin: 0; padding: 0;
            background-color: #fffcf5 !important;
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            z-index: 9999;
          }
          @page { size: landscape; margin: 0; }
        }
      `}</style>

      {/* Main Layout */}
      <div className="flex flex-col lg:flex-row min-h-screen">
        
        {/* Sidebar Controls (Hidden on Print) */}
        <div className="no-print w-full lg:w-1/3 bg-white p-6 shadow-xl z-10 overflow-y-auto border-r border-gray-200">
          <div className="mb-6 border-b pb-4">
            <h1 className="text-2xl font-header font-bold text-slate-800 flex items-center gap-2">
              <Award className="w-6 h-6 text-yellow-600" />
              Certificate Editor
            </h1>
            <p className="text-sm text-gray-500 mt-1 font-body">Customize your official document</p>
          </div>

          <div className="space-y-4">
            
            {/* Download Actions */}
            <div className="flex flex-col gap-2 mb-6">
               <button 
                onClick={handleDownloadPDF}
                disabled={isGenerating || !areScriptsLoaded}
                className="w-full bg-slate-800 hover:bg-slate-900 text-yellow-50 px-4 py-3 rounded shadow-md font-header font-bold text-sm tracking-widest flex items-center justify-center gap-2 transition-all uppercase disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {isGenerating ? (
                    <span>Processing...</span>
                ) : (
                    <>
                        <FileText className="w-4 h-4" />
                        Download PDF
                    </>
                )}
              </button>
              
              <div className="grid grid-cols-2 gap-2">
                  <button 
                    onClick={handleDownloadImage}
                    disabled={isGenerating || !areScriptsLoaded}
                    className="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded shadow font-bold text-xs tracking-widest flex items-center justify-center gap-2 transition-all uppercase disabled:opacity-50"
                  >
                    <ImageIcon className="w-3 h-3" />
                    Download PNG
                  </button>
                  <button 
                    onClick={handlePrint}
                    className="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-3 py-2 rounded shadow font-bold text-xs tracking-widest flex items-center justify-center gap-2 transition-all uppercase"
                  >
                    <Printer className="w-3 h-3" />
                    Print
                  </button>
              </div>
            </div>

            {/* Institution Image */}
            <div className="p-4 border-2 border-dashed border-yellow-600/30 rounded-lg hover:border-yellow-600/60 transition-colors text-center cursor-pointer bg-yellow-50/30" onClick={() => fileInputRef.current.click()}>
              <input 
                type="file" 
                ref={fileInputRef} 
                onChange={handleImageUpload} 
                className="hidden" 
                accept="image/*"
              />
              <div className="w-12 h-12 mx-auto mb-2 rounded-full border-2 border-yellow-600/20 flex items-center justify-center bg-white overflow-hidden">
                 {image ? (
                    <img src={image} className="w-full h-full object-cover" alt="preview" />
                 ) : (
                    <Upload className="w-5 h-5 text-yellow-700" />
                 )}
              </div>
              <p className="text-xs font-semibold text-slate-700">
                {image ? "Change Logo" : "Upload Circular Logo"}
              </p>
            </div>

            {/* Input Fields */}
            <div>
              <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Title</label>
              <input
                type="text"
                name="title"
                value={data.title}
                onChange={handleInputChange}
                className="w-full px-3 py-2 border border-slate-300 rounded focus:ring-1 focus:ring-yellow-600 focus:border-yellow-600 outline-none"
              />
            </div>

            <div>
              <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Institution</label>
              <input
                type="text"
                name="institutionName"
                value={data.institutionName}
                onChange={handleInputChange}
                className="w-full px-3 py-2 border border-slate-300 rounded focus:ring-1 focus:ring-yellow-600 focus:border-yellow-600 outline-none"
              />
            </div>

            <div>
              <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Recipient Name</label>
              <div className="relative">
                <User className="absolute left-3 top-2.5 h-4 w-4 text-slate-400" />
                <input
                  type="text"
                  name="candidateName"
                  value={data.candidateName}
                  onChange={handleInputChange}
                  className="w-full pl-9 pr-3 py-2 border border-slate-300 rounded focus:ring-1 focus:ring-yellow-600 focus:border-yellow-600 outline-none font-semibold"
                />
              </div>
            </div>

            <div>
              <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Citation Text</label>
              <textarea
                name="description"
                value={data.description}
                onChange={handleInputChange}
                rows={3}
                className="w-full px-3 py-2 border border-slate-300 rounded focus:ring-1 focus:ring-yellow-600 focus:border-yellow-600 outline-none"
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Date</label>
                <input
                  type="date"
                  name="date"
                  value={data.date}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-slate-300 rounded focus:ring-1 focus:ring-yellow-600 focus:border-yellow-600 outline-none"
                />
              </div>
              <div>
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Signatory Name</label>
                <input
                  type="text"
                  name="founderName"
                  value={data.founderName}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-slate-300 rounded focus:ring-1 focus:ring-yellow-600 focus:border-yellow-600 outline-none"
                />
              </div>
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Signatory Title</label>
                <input
                  type="text"
                  name="signatoryTitle"
                  value={data.signatoryTitle}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-slate-300 rounded focus:ring-1 focus:ring-yellow-600 focus:border-yellow-600 outline-none"
                  placeholder="e.g. Founder / Head"
                />
              </div>
              <div>
                <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Email</label>
                <input
                  type="email"
                  name="founderEmail"
                  value={data.founderEmail}
                  onChange={handleInputChange}
                  className="w-full px-3 py-2 border border-slate-300 rounded focus:ring-1 focus:ring-yellow-600 focus:border-yellow-600 outline-none"
                />
              </div>
            </div>

            <div className="bg-slate-50 p-3 rounded-lg border border-slate-200">
              <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">QR Code Mode</label>
              
              <div className="flex gap-2 mb-3">
                <button 
                  onClick={() => setQrMode('details')}
                  className={`flex-1 py-1.5 px-2 rounded text-xs font-bold flex items-center justify-center gap-1 transition-all ${qrMode === 'details' ? 'bg-slate-700 text-white shadow-sm' : 'bg-white text-slate-600 border border-slate-200 hover:bg-gray-50'}`}
                >
                  <FileJson className="w-3 h-3" /> Embed Details
                </button>
                <button 
                  onClick={() => setQrMode('link')}
                  className={`flex-1 py-1.5 px-2 rounded text-xs font-bold flex items-center justify-center gap-1 transition-all ${qrMode === 'link' ? 'bg-slate-700 text-white shadow-sm' : 'bg-white text-slate-600 border border-slate-200 hover:bg-gray-50'}`}
                >
                  <LinkIcon className="w-3 h-3" /> Website Link
                </button>
              </div>

              {qrMode === 'link' ? (
                <div className="relative">
                  <QrCode className="absolute left-3 top-2.5 h-4 w-4 text-slate-400" />
                  <input
                    type="text"
                    name="verificationUrl"
                    value={data.verificationUrl}
                    onChange={handleInputChange}
                    className="w-full pl-9 pr-3 py-2 border border-slate-300 rounded focus:ring-1 focus:ring-yellow-600 focus:border-yellow-600 outline-none text-sm"
                    placeholder="https://your-site.com/verify/..."
                  />
                </div>
              ) : (
                <div className="text-xs text-slate-500 italic p-2 bg-slate-100 rounded leading-relaxed">
                  The QR code will store the Name, Date, and Issuer directly. <br/>
                  <span className="font-semibold text-slate-700">Scan with Google Lens â†’ Text Tab</span> to see details.
                </div>
              )}
            </div>

            <div className="pt-4 border-t">
                 <button 
                  onClick={handleReset}
                  className="w-full bg-white border border-slate-300 hover:bg-slate-50 text-slate-600 px-3 py-2 rounded shadow-sm transition-colors text-xs font-medium flex items-center justify-center gap-2"
                >
                  <RotateCcw className="w-3 h-3" /> Reset Form
                </button>
            </div>

          </div>
        </div>

        {/* Preview Area */}
        <div className="flex-1 bg-slate-800 p-4 lg:p-8 overflow-auto flex items-center justify-center">
          
          {/* Certificate Container (A4 Landscape) */}
          <div ref={certificateRef}
               className="print-area bg-parchment shadow-2xl relative text-slate-900" 
               style={{ 
                 width: '297mm', 
                 height: '210mm', 
                 minWidth: '297mm',
                 minHeight: '210mm',
               }}>
            
            {/* 1. Main Outer Border (Dark Navy) */}
            <div className="absolute inset-4 border-[6px] border-slate-900 z-10"></div>
            
            {/* 2. Inner Gold Border */}
            <div className="absolute inset-6 border-[2px] border-gold z-10"></div>
            
            {/* 3. Ornamental Corners */}
            {/* Top Left */}
            <div className="absolute top-6 left-6 w-16 h-16 border-t-[4px] border-l-[4px] border-slate-900 z-20"></div>
            <div className="absolute top-8 left-8 w-12 h-12 border-t-[1px] border-l-[1px] border-gold z-20"></div>
            
            {/* Top Right */}
            <div className="absolute top-6 right-6 w-16 h-16 border-t-[4px] border-r-[4px] border-slate-900 z-20"></div>
            <div className="absolute top-8 right-8 w-12 h-12 border-t-[1px] border-r-[1px] border-gold z-20"></div>
            
            {/* Bottom Left */}
            <div className="absolute bottom-6 left-6 w-16 h-16 border-b-[4px] border-l-[4px] border-slate-900 z-20"></div>
            <div className="absolute bottom-8 left-8 w-12 h-12 border-b-[1px] border-l-[1px] border-gold z-20"></div>
            
            {/* Bottom Right */}
            <div className="absolute bottom-6 right-6 w-16 h-16 border-b-[4px] border-r-[4px] border-slate-900 z-20"></div>
            <div className="absolute bottom-8 right-8 w-12 h-12 border-b-[1px] border-r-[1px] border-gold z-20"></div>

            {/* Content Flex Wrapper */}
            <div className="relative h-full flex flex-col items-center justify-between pt-16 pb-12 px-24 z-30">
              
              {/* Header Section */}
              <div className="w-full flex flex-col items-center">
                 {/* Circular Logo Container */}
                 <div className="relative mb-4">
                    <div className="w-28 h-28 rounded-full border-[4px] border-slate-900 bg-white flex items-center justify-center overflow-hidden shadow-lg relative z-10">
                      {image ? (
                        <img src={image} alt="Logo" className="w-full h-full object-cover" />
                      ) : (
                        <div className="flex flex-col items-center justify-center text-slate-300">
                           <Award className="w-10 h-10" />
                           <span className="text-[10px] font-header mt-1">Logo</span>
                        </div>
                      )}
                    </div>
                    {/* Decorative ribbon behind logo */}
                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-36 h-[2px] bg-gold -z-0"></div>
                 </div>

                 <h2 className="text-2xl font-header font-bold text-slate-800 uppercase tracking-widest mb-1">
                   {data.institutionName}
                 </h2>
                 <p className="font-body text-slate-600 text-lg italic mb-4">is honored to present</p>
                 
                 <h1 className="text-4xl font-header font-black text-gold drop-shadow-sm uppercase tracking-wider border-b-2 border-slate-900 pb-2 px-12">
                   {data.title}
                 </h1>
              </div>

              {/* Recipient Section */}
              <div className="w-full text-center my-2 flex-grow flex flex-col justify-center">
                 <p className="font-body text-xl text-slate-500 mb-2 italic">to</p>
                 {/* Plain serif font (Cinzel) for Name */}
                 <div className="text-5xl font-header font-bold text-slate-900 mb-4 px-4 tracking-wide uppercase">
                   {data.candidateName}
                 </div>
                 
                 <div className="max-w-3xl mx-auto">
                   <p className="text-xl font-body leading-relaxed text-slate-700">
                     {data.description}
                   </p>
                 </div>
              </div>

              {/* Footer Section - Signatures and Seal */}
              <div className="w-full flex justify-between items-end mt-4">
                 
                 {/* Left Signature (Date) */}
                 <div className="flex flex-col items-center w-56">
                    <div className="w-full border-b border-slate-400 mb-2 text-center pb-1">
                       <span className="font-header text-lg font-bold text-slate-800">{data.date}</span>
                    </div>
                    <span className="font-header text-xs font-bold text-slate-500 uppercase tracking-widest">Date</span>
                 </div>

                 {/* Center - Verification QR Code Badge */}
                 <div className="relative mx-4 flex flex-col items-center">
                    <div className="w-32 h-32 rounded-full bg-gradient-to-br from-yellow-400 via-yellow-600 to-yellow-800 shadow-md flex items-center justify-center p-1.5">
                       <div className="w-full h-full rounded-full border-2 border-yellow-200 border-dashed flex items-center justify-center bg-white overflow-hidden">
                            <img 
                                src={qrCodeUrl} 
                                alt="Verification QR" 
                                className="w-24 h-24 mix-blend-multiply" 
                            />
                       </div>
                    </div>
                    <span className="font-header text-[10px] font-bold tracking-widest text-slate-600 mt-2 uppercase">Scan to Verify</span>
                 </div>

                 {/* Right Signature (Founder) */}
                 <div className="flex flex-col items-center w-56">
                    <div className="w-full border-b border-slate-400 mb-2 text-center pb-1 min-h-[30px] flex items-end justify-center">
                       {/* Plain text signature */}
                       <span className="font-header text-xl font-bold text-slate-900 uppercase">
                          {data.founderName}
                       </span>
                    </div>
                    {/* Founder / Head Label */}
                    <span className="font-header text-xs font-bold text-slate-800 uppercase tracking-wide">
                        {data.signatoryTitle}
                    </span>
                     {/* Email */}
                    <span className="font-body text-xs text-slate-500 italic mt-0.5">
                        {data.founderEmail}
                    </span>
                 </div>

              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
